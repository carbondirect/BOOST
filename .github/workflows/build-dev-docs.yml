name: üìö Build Development Documentation

on:
  push:
    branches: 
      - develop
      - 'feature/**'
      - 'fix/**'
      - 'docs/**'
      - boost-doc              # Your current development branch
    paths:
      - 'drafts/current/specifications/**'
      - 'drafts/current/schema/**'
      - '.github/workflows/**'

  # Allow manual triggering for any branch
  workflow_dispatch:
    inputs:
      include_pdf:
        description: 'Generate PDF documentation (may timeout in Docker)'
        required: false
        type: boolean
        default: false

# Allow concurrent builds on different branches
concurrency:
  group: build-dev-docs-${{ github.ref }}
  cancel-in-progress: true

jobs:
  extract-version:
    name: üè∑Ô∏è Extract Version Info (Development)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      version: ${{ steps.version-info.outputs.version }}
      build-timestamp: ${{ steps.version-info.outputs.timestamp }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full git history for version extraction
      
      - name: Extract version information
        id: version-info
        run: |
          echo "üîç Extracting version information for development build..."
          
          # Extract version for development builds
          if git describe --tags >/dev/null 2>&1; then
              VERSION=$(git describe --tags --always)
              echo "üìã Using detailed git version: $VERSION"
          else
              VERSION=$(git describe --tags --abbrev=0 2>/dev/null)
              if [ -z "$VERSION" ]; then
                  SHORT_HASH=$(git rev-parse --short HEAD)
                  VERSION="v0.0.0-dev-${SHORT_HASH}"
                  echo "‚ö†Ô∏è No git tags found, using commit hash: $VERSION"
              else
                  SHORT_HASH=$(git rev-parse --short HEAD)
                  VERSION="${VERSION}-dev-${SHORT_HASH}"
                  echo "üìã Using tagged development version: $VERSION"
              fi
          fi
          
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          BRANCH_NAME="${{ github.ref_name }}"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          echo "::notice title=Development Build::Building BOOST Documentation $VERSION on branch $BRANCH_NAME"

  build-dev-documentation:
    name: üìñ Build Documentation (Development)
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Prevent stuck dev builds - Docker should be ~2-3 min
    needs: extract-version
    container:
      image: ghcr.io/carbondirect/boost/boost-builder:latest
      options: --pull=missing
      env:
        RELEASE_VERSION: ${{ needs.extract-version.outputs.version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify containerized environment
        run: |
          echo "üê≥ Docker containerized development build environment"
          echo "Python version: $(python3 --version)"
          echo "Bikeshed version: $(bikeshed --version)"
          echo "TeXLive available: $(which pdflatex && echo 'Yes' || echo 'No')"
          echo "Pandoc version: $(pandoc --version | head -1)"

      - name: Confirm version information
        run: |
          echo "üè∑Ô∏è Using pre-extracted version: ${{ needs.extract-version.outputs.version }}"
          echo "‚è∞ Build timestamp: ${{ needs.extract-version.outputs.timestamp }}"
          echo "üê≥ Container environment variable RELEASE_VERSION: $RELEASE_VERSION"
          
          # Verify the environment variable is set correctly
          if [ "$RELEASE_VERSION" != "${{ needs.extract-version.outputs.version }}" ]; then
              echo "‚ö†Ô∏è Warning: Environment variable mismatch"
              echo "  Pre-extracted: ${{ needs.extract-version.outputs.version }}"
              echo "  Container env:  $RELEASE_VERSION"
          else
              echo "‚úÖ Version successfully passed to Docker container"
          fi
          
          echo "::notice title=Development Build Version::Building BOOST Documentation ${{ needs.extract-version.outputs.version }}"

      - name: Run schema validation
        working-directory: drafts/current/specifications
        run: |
          echo "üîç Running schema validation..."
          python3 -c "
          import json
          import sys
          from pathlib import Path
          
          schema_dir = Path('../schema')
          errors = []
          validated = 0
          
          for schema_file in schema_dir.rglob('validation_schema.json'):
              try:
                  with open(schema_file, 'r') as f:
                      schema_data = json.load(f)
                  validated += 1
              except Exception as e:
                  errors.append(f'Error in {schema_file}: {e}')
          
          if errors:
              for error in errors:
                  print(f'‚ùå {error}')
              sys.exit(1)
          
          print(f'‚úÖ Schema validation passed for {validated} schemas')
          "

      - name: Build HTML documentation  
        working-directory: drafts/current/specifications
        run: |
          echo "üèóÔ∏è Building HTML documentation with consolidated build system..."
          echo "üìã Branch: ${{ needs.extract-version.outputs.branch }}"
          echo "üîß Version: ${{ needs.extract-version.outputs.version }}"
          echo "üéØ Build type: Development (no deployment)"
          
          chmod +x build.sh
          ./build.sh --html

      - name: Build PDF documentation
        if: github.event.inputs.include_pdf == 'true'
        working-directory: drafts/current/specifications
        run: |
          echo "üìÑ Building PDF documentation for development with consolidated build system..."
          echo "‚ö†Ô∏è  Note: PDF builds in Docker containers may have resource limitations"
          timeout 300 ./build.sh --pdf || {
            echo "‚ùå PDF build timed out after 5 minutes - this is expected in resource-constrained environments"
            echo "‚úÖ HTML documentation was built successfully"
            exit 0
          }

      - name: Validate build output
        working-directory: drafts/current/specifications
        run: |
          echo "üîç Validating development build output..."
          
          # Check HTML
          if [ ! -f "boost-spec.html" ]; then
            echo "‚ùå HTML documentation not generated"
            exit 1
          fi
          
          HTML_SIZE=$(wc -c < boost-spec.html)
          if [ "$HTML_SIZE" -lt 100000 ]; then
            echo "‚ùå HTML file too small ($HTML_SIZE bytes)"
            exit 1
          fi
          
          # Check content
          if ! grep -q "BOOST" boost-spec.html; then
            echo "‚ùå HTML missing BOOST content"
            exit 1
          fi
          
          # Check ERD Navigator
          if [ ! -f "erd-navigator/index.html" ]; then
            echo "‚ö†Ô∏è ERD Navigator not found"
          else
            echo "‚úÖ ERD Navigator present"
          fi
          
          echo "‚úÖ Development build validation passed"
          echo "üìä HTML Size: $(echo $HTML_SIZE | numfmt --to=iec-i --suffix=B)"

      - name: Generate development build report
        working-directory: drafts/current/specifications
        shell: bash
        run: |
          cat > dev-build-report.md << EOF
          # üìö BOOST Development Build Report
          
          **Branch:** ${{ needs.extract-version.outputs.branch }}
          **Version:** ${{ needs.extract-version.outputs.version }}
          **Build Time:** ${{ needs.extract-version.outputs.timestamp }}
          **Commit:** ${GITHUB_SHA::8}
          **Build Type:** Development (No Deployment)
          
          ## üèóÔ∏è Build Results
          
          - ‚úÖ **HTML Documentation:** $(wc -c < boost-spec.html | numfmt --to=iec-i --suffix=B)
          - $([ -f "build/boost-spec.pdf" ] && echo "‚úÖ **PDF Documentation:** $(wc -c < build/boost-spec.pdf | numfmt --to=iec-i --suffix=B)" || echo "‚ö†Ô∏è **PDF Documentation:** Not generated (disabled by default for faster development builds)")
          - ‚úÖ **ERD Navigator:** Interactive tool included
          - ‚úÖ **Schema Files:** $(find ../schema -name "validation_schema.json" | wc -l) validated schemas
          
          ## üìã Development Notes
          
          This is a development build from the **${{ needs.extract-version.outputs.branch }}** branch.
          - No deployment to GitHub Pages
          - Artifacts retained for 7 days
          - PDF optimized for development review
          
          ## üîó Next Steps
          
          - Review documentation changes
          - Test ERD Navigator functionality  
          - Validate schema modifications
          - Create PR to main branch for production deployment
          
          ---
          
          üí° **Tip:** Use the artifacts below to download and review the complete documentation package.
          EOF
          
          echo "üìã Development Build Report:"
          cat dev-build-report.md

      - name: Upload development build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: boost-dev-docs-${{ needs.extract-version.outputs.branch }}-${{ github.run_number }}
          path: |
            drafts/current/specifications/boost-spec.html
            drafts/current/specifications/build/boost-spec.pdf
            drafts/current/specifications/dev-build-report.md
            drafts/current/specifications/erd-navigator/
            drafts/current/schema/
            drafts/current/specifications/respec-style.css
          retention-days: 7

      - name: Development build summary
        run: |
          echo "## üéâ Development Build Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ needs.extract-version.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.extract-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Time:** ${{ needs.extract-version.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Generated Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- üìÑ HTML Documentation with ReSpec styling" >> $GITHUB_STEP_SUMMARY
          echo "- $([ -f "drafts/current/specifications/build/boost-spec.pdf" ] && echo "üìã PDF Documentation for offline review" || echo "‚ö†Ô∏è PDF generation disabled by default for faster builds")" >> $GITHUB_STEP_SUMMARY
          echo "- üîç Interactive ERD Navigator" >> $GITHUB_STEP_SUMMARY
          echo "- üìä All schema validation files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üöÄ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download artifacts to review documentation" >> $GITHUB_STEP_SUMMARY
          echo "2. Test functionality and validate changes" >> $GITHUB_STEP_SUMMARY
          echo "3. Create PR to main branch for production deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üí° This build does not deploy - it's for development review only!" >> $GITHUB_STEP_SUMMARY