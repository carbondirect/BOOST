<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOOST ERD - D3.js Interactive Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            background: #f8f9fa;
            font-size: 14px;
            font-weight: 500;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 2px solid;
        }
        
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .controls button {
            margin: 0 5px;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background: #3498db;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .controls button:hover {
            background: #2980b9;
        }
        
        .controls button.active {
            background: #2c3e50;
        }
        
        .svg-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .entity {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .entity:hover {
            filter: brightness(0.95);
            stroke-width: 3px !important;
        }
        
        .entity-header {
            font-weight: bold;
            font-size: 14px;
        }
        
        .entity-field {
            font-size: 11px;
            fill: #2c3e50;
        }
        
        .entity-pk {
            font-weight: bold;
            fill: #e74c3c;
        }
        
        .entity-fk {
            font-weight: bold;
            fill: #3498db;
        }
        
        .relationship {
            stroke: #7f8c8d;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }
        
        .relationship:hover {
            stroke: #2c3e50;
            stroke-width: 3;
        }
        
        .relationship-label {
            font-size: 10px;
            fill: #7f8c8d;
            text-anchor: middle;
            pointer-events: none;
        }
        
        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>BOOST Biomass Chain of Custody ERD</h1>
            <p>Interactive D3.js Visualization - Hover entities for details, click to highlight relationships</p>
        </div>
        
        <div class="legend" id="legend"></div>
        
        <div class="controls">
            <button onclick="showAll()" class="active">Show All</button>
            <button onclick="filterByArea('Core Traceability')">Core Traceability</button>
            <button onclick="filterByArea('Organizational Foundation')">Organizations</button>
            <button onclick="filterByArea('Transaction Management')">Transactions</button>
            <button onclick="resetLayout()">Reset Layout</button>
        </div>
        
        <div class="svg-container">
            <svg id="erd-svg" width="1400" height="1000"></svg>
        </div>
        
        <div class="tooltip" id="tooltip"></div>
    </div>

    <script>
        // Configuration
        const config = {
            width: 1400,
            height: 1000,
            entityWidth: 200,
            entityFieldHeight: 16,
            entityPadding: 10,
            colors: {
                'Core Traceability': { fill: '#e8f5e8', stroke: '#2e7d32', text: '#1b5e20' },
                'Organizational Foundation': { fill: '#e3f2fd', stroke: '#1976d2', text: '#0d47a1' },
                'Material & Supply Chain': { fill: '#efebe9', stroke: '#8d6e63', text: '#5d4037' },
                'Transaction Management': { fill: '#fff3e0', stroke: '#ff8f00', text: '#e65100' },
                'Sustainability & Claims': { fill: '#fffde7', stroke: '#fbc02d', text: '#f57f17' },
                'Geographic & Location': { fill: '#f3e5f5', stroke: '#7b1fa2', text: '#4a148c' },
                'Reporting & Compliance': { fill: '#ffebee', stroke: '#d32f2f', text: '#b71c1c' },
                'Analytics & Data Management': { fill: '#fafafa', stroke: '#616161', text: '#424242' },
                'Personnel Management': { fill: '#fff8e1', stroke: '#795548', text: '#5d4037' }
            }
        };

        // Data structure
        const entities = [
            {
                id: 'TraceableUnit',
                name: 'TraceableUnit',
                area: 'Core Traceability',
                description: 'Central entity for biomass tracking - the heart of BOOST traceability',
                fields: [
                    { name: 'traceableUnitId', type: 'PK', description: 'Unique identifier for each TRU' },
                    { name: 'unitType', type: 'string', description: 'Type of traceable unit' },
                    { name: 'totalVolumeM3', type: 'decimal', description: 'Total volume' },
                    { name: 'currentMoistureContent', type: 'decimal', description: 'Current moisture %' },
                    { name: 'currentGeographicDataId', type: 'FK', description: 'Current location' },
                    { name: 'materialTypeId', type: 'FK', description: 'Material reference' }
                ],
                x: 600, y: 200
            },
            {
                id: 'MaterialProcessing',
                name: 'MaterialProcessing',
                area: 'Core Traceability',
                description: 'Processing operations that transform TRUs',
                fields: [
                    { name: 'processingId', type: 'PK', description: 'Processing operation ID' },
                    { name: 'inputTraceableUnitId', type: 'FK', description: 'Input TRU' },
                    { name: 'outputTraceableUnitId', type: 'FK', description: 'Output TRU' },
                    { name: 'processType', type: 'string', description: 'Type of processing' },
                    { name: 'operatorId', type: 'FK', description: 'Operator performing' }
                ],
                x: 350, y: 400
            },
            {
                id: 'ProcessingHistory',
                name: 'ProcessingHistory',
                area: 'Core Traceability',
                description: 'Complete timeline of processing events for each TRU',
                fields: [
                    { name: 'processingHistoryId', type: 'PK', description: 'History record ID' },
                    { name: 'traceableUnitId', type: 'FK', description: 'TRU reference' },
                    { name: 'materialProcessingId', type: 'FK', description: 'Processing reference' },
                    { name: 'processSequenceNumber', type: 'integer', description: 'Sequence order' },
                    { name: 'moistureChangeRatio', type: 'decimal', description: 'Moisture change' }
                ],
                x: 850, y: 400
            },
            {
                id: 'Organization',
                name: 'Organization',
                area: 'Organizational Foundation',
                description: 'Business entities in the supply chain',
                fields: [
                    { name: 'organizationId', type: 'PK', description: 'Organization identifier' },
                    { name: 'name', type: 'string', description: 'Organization name' },
                    { name: 'role', type: 'string', description: 'Business role' },
                    { name: 'certificateCode', type: 'FK', description: 'Certification reference' }
                ],
                x: 100, y: 200
            },
            {
                id: 'Certificate',
                name: 'Certificate',
                area: 'Organizational Foundation',
                description: 'Certification credentials and compliance',
                fields: [
                    { name: 'certificateNumber', type: 'PK', description: 'Certificate ID' },
                    { name: 'organizationId', type: 'FK', description: 'Certified organization' },
                    { name: 'dateOfExpiry', type: 'date', description: 'Expiration date' },
                    { name: 'status', type: 'string', description: 'Certificate status' }
                ],
                x: 100, y: 50
            },
            {
                id: 'Transaction',
                name: 'Transaction',
                area: 'Transaction Management',
                description: 'Business transactions between organizations',
                fields: [
                    { name: 'transactionId', type: 'PK', description: 'Transaction identifier' },
                    { name: 'supplyingOrganizationId', type: 'FK', description: 'Seller' },
                    { name: 'customerOrganizationId', type: 'FK', description: 'Buyer' },
                    { name: 'contractValue', type: 'decimal', description: 'Transaction value' }
                ],
                x: 1100, y: 200
            },
            {
                id: 'GeographicData',
                name: 'GeographicData',
                area: 'Geographic & Location',
                description: 'Spatial data and location information',
                fields: [
                    { name: 'geographicDataId', type: 'PK', description: 'Geographic identifier' },
                    { name: 'geoJsonData', type: 'json', description: 'GeoJSON data' },
                    { name: 'dataType', type: 'string', description: 'Location type' }
                ],
                x: 600, y: 50
            },
            {
                id: 'Operator',
                name: 'Operator',
                area: 'Personnel Management',
                description: 'Personnel performing operations',
                fields: [
                    { name: 'operatorId', type: 'PK', description: 'Operator identifier' },
                    { name: 'organizationId', type: 'FK', description: 'Employer' },
                    { name: 'operatorType', type: 'string', description: 'Role type' },
                    { name: 'certifications', type: 'array', description: 'Held certifications' }
                ],
                x: 350, y: 600
            }
        ];

        const relationships = [
            { from: 'TraceableUnit', to: 'MaterialProcessing', label: 'undergoes', type: 'one-to-many' },
            { from: 'TraceableUnit', to: 'ProcessingHistory', label: 'has timeline', type: 'one-to-many' },
            { from: 'MaterialProcessing', to: 'ProcessingHistory', label: 'documented by', type: 'one-to-many' },
            { from: 'Organization', to: 'Certificate', label: 'has', type: 'one-to-many' },
            { from: 'Organization', to: 'TraceableUnit', label: 'manages', type: 'one-to-many' },
            { from: 'Organization', to: 'Transaction', label: 'creates', type: 'one-to-many' },
            { from: 'GeographicData', to: 'TraceableUnit', label: 'locates', type: 'one-to-many' },
            { from: 'Operator', to: 'MaterialProcessing', label: 'performs', type: 'one-to-many' },
            { from: 'Organization', to: 'Operator', label: 'employs', type: 'one-to-many' }
        ];

        // Initialize D3 visualization
        const svg = d3.select('#erd-svg');
        const tooltip = d3.select('#tooltip');
        
        // Define arrowhead marker
        svg.append('defs').append('marker')
            .attr('id', 'arrowhead')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 8)
            .attr('refY', 0)
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M 0,-5 L 10,0 L 0,5')
            .attr('fill', '#7f8c8d');

        let currentFilter = null;

        function createLegend() {
            const legend = d3.select('#legend');
            const areas = [...new Set(entities.map(e => e.area))];
            
            areas.forEach(area => {
                const item = legend.append('div')
                    .attr('class', 'legend-item')
                    .style('cursor', 'pointer')
                    .on('click', () => filterByArea(area));
                
                item.append('div')
                    .attr('class', 'legend-color')
                    .style('background-color', config.colors[area].fill)
                    .style('border-color', config.colors[area].stroke);
                
                item.append('span')
                    .text(area);
            });
        }

        function drawEntity(entity) {
            const color = config.colors[entity.area];
            const fieldCount = Math.min(entity.fields.length, 6); // Limit displayed fields
            const entityHeight = 30 + (fieldCount * config.entityFieldHeight) + (config.entityPadding * 2);
            
            const g = svg.append('g')
                .attr('class', 'entity')
                .attr('data-area', entity.area)
                .attr('data-id', entity.id);

            // Entity background
            g.append('rect')
                .attr('x', entity.x)
                .attr('y', entity.y)
                .attr('width', config.entityWidth)
                .attr('height', entityHeight)
                .attr('fill', color.fill)
                .attr('stroke', color.stroke)
                .attr('stroke-width', 2)
                .attr('rx', 6);

            // Header background (this gives us header-only coloring effect)
            g.append('rect')
                .attr('x', entity.x)
                .attr('y', entity.y)
                .attr('width', config.entityWidth)
                .attr('height', 30)
                .attr('fill', color.stroke)
                .attr('rx', 6);
                
            // Fix bottom corners of header
            g.append('rect')
                .attr('x', entity.x)
                .attr('y', entity.y + 24)
                .attr('width', config.entityWidth)
                .attr('height', 6)
                .attr('fill', color.stroke);

            // Entity name (header)
            g.append('text')
                .attr('class', 'entity-header')
                .attr('x', entity.x + config.entityWidth / 2)
                .attr('y', entity.y + 20)
                .attr('text-anchor', 'middle')
                .attr('fill', 'white')
                .text(entity.name);

            // Fields
            entity.fields.slice(0, 6).forEach((field, i) => {
                const fieldY = entity.y + 45 + (i * config.entityFieldHeight);
                const fieldClass = field.type === 'PK' ? 'entity-pk' : field.type === 'FK' ? 'entity-fk' : 'entity-field';
                
                g.append('text')
                    .attr('class', fieldClass)
                    .attr('x', entity.x + 8)
                    .attr('y', fieldY)
                    .text(`${field.name} (${field.type})`);
            });

            // Add hover effects
            g.on('mouseover', function(event) {
                tooltip.style('opacity', 1)
                    .html(`<strong>${entity.name}</strong><br/>${entity.description}<br/><em>Area: ${entity.area}</em>`)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 10) + 'px');
            })
            .on('mouseout', function() {
                tooltip.style('opacity', 0);
            })
            .on('click', function() {
                highlightRelationships(entity.id);
            });

            return { entity, height: entityHeight };
        }

        function drawRelationships() {
            relationships.forEach(rel => {
                const fromEntity = entities.find(e => e.id === rel.from);
                const toEntity = entities.find(e => e.id === rel.to);
                
                if (fromEntity && toEntity) {
                    const line = svg.append('line')
                        .attr('class', 'relationship')
                        .attr('data-from', rel.from)
                        .attr('data-to', rel.to)
                        .attr('x1', fromEntity.x + config.entityWidth / 2)
                        .attr('y1', fromEntity.y + 100) // Approximate entity bottom
                        .attr('x2', toEntity.x + config.entityWidth / 2)
                        .attr('y2', toEntity.y + 20); // Approximate entity top
                }
            });
        }

        function showAll() {
            currentFilter = null;
            svg.selectAll('.entity').style('opacity', 1);
            svg.selectAll('.relationship').style('opacity', 0.6);
            d3.selectAll('.controls button').classed('active', false);
            d3.select(event.target).classed('active', true);
        }

        function filterByArea(area) {
            currentFilter = area;
            svg.selectAll('.entity').style('opacity', function() {
                return d3.select(this).attr('data-area') === area ? 1 : 0.2;
            });
            svg.selectAll('.relationship').style('opacity', 0.2);
            d3.selectAll('.controls button').classed('active', false);
            d3.select(event.target).classed('active', true);
        }

        function highlightRelationships(entityId) {
            svg.selectAll('.relationship').style('opacity', function() {
                const from = d3.select(this).attr('data-from');
                const to = d3.select(this).attr('data-to');
                return (from === entityId || to === entityId) ? 1 : 0.2;
            });
            
            svg.selectAll('.entity').style('opacity', function() {
                const id = d3.select(this).attr('data-id');
                const isConnected = relationships.some(rel => 
                    (rel.from === entityId && rel.to === id) || 
                    (rel.to === entityId && rel.from === id)
                );
                return (id === entityId || isConnected) ? 1 : 0.3;
            });
        }

        function resetLayout() {
            showAll();
            // Could add animation here to reset positions
        }

        // Initialize the visualization
        function init() {
            createLegend();
            entities.forEach(entity => drawEntity(entity));
            drawRelationships();
        }

        // Start the visualization
        init();
    </script>
</body>
</html>